# GEMINI_zh.md for gmd-cli

本文档概述了 `gmd-cli` 项目的开发计划和规范。

## 1. 项目概览

`gmd-cli` 是一个完全由 **Bash 脚本**编写的命令行界面 (CLI) 工具。其主要目的是帮助开发者独立于主项目仓库管理和版本控制 `GEMINI.md` 文件。

这解决了公司政策限制将工具特定配置文件（如 `GEMINI.md`）提交到主代码库的常见问题。`gmd-cli` 允许这些文件在独立的私有 Git 仓库中进行跟踪，从而在不污染项目历史的情况下提供版本控制的优势。

## 2. 核心架构

该系统采用**双仓库模型**：

1.  **工具仓库 (`gmd-cli`)**：这个公共仓库包含 `gmd` 工具本身的 Bash 脚本源代码。它是一个标准的软件项目。
2.  **数据保险库仓库 (`gemini-md-vault`)**：这是一个独立的、用户拥有的**私有** Git 仓库。它充当一个集中的“保险库”，用于存储用户所有项目中的 `GEMINI.md` 文件。

`gmd` 脚本是协调器，负责在用户的本地项目目录和其私有数据保险库之间同步文件。

## 3. 技术栈

- **语言**：Bash 脚本
- **理由**：选择 Bash 是因为它与类 Unix 环境的原生集成、直接访问系统命令（`git`、`find`、`cp`、`ssh-agent`）的能力，以及继承 shell 环境的特性。这对于可靠的 SSH 认证至关重要。这种方法避免了 Go 语言的 `os/exec` 和 `go-git` 库在处理非交互式环境中的 SSH 代理和 `known_hosts` 时遇到的复杂性。它为 Linux/macOS 用户提供了零依赖的运行时，并简化了分发。

## 4. 配置

该工具将通过位于 `~/.config/gmd/config.toml` 的 TOML 文件进行配置。

**初始配置示例：**

```toml
# 用户私有 gemini-md-vault 仓库的 SSH 或 HTTPS Git URL。
vault_url = "git@github.com:user/gemini-md-vault.git"
```

`gmd init` 命令将负责创建此文件并提示用户输入 `vault_url`。

## 5. 命令行界面 (CLI) 规范

该工具将通过 `gmd` 命令调用。

### 5.1. `gmd init`

- **操作**：初始化 `gmd` 配置。
- **工作流程**：
  1.  检查 `~/.config/gmd/config.toml` 是否存在。
  2.  如果不存在，则创建目录和空的配置文件。
  3.  交互式提示用户输入其私有 `gemini-md-vault` 仓库的 URL。
  4.  将 URL 保存到配置文件中。
- **选项**：
  - `--vault-url <url>`：允许直接通过标志提供保险库 URL，跳过交互式提示。

### 5.2. `gmd sync`

- **操作**：扫描当前项目，查找所有 `GEMINI.md` 文件，并将其提交到数据保险库。
- **工作流程**：
  1.  识别项目的根目录（包含 `.git` 文件夹的目录）。
  2.  扫描整个项目目录以查找名为 `GEMINI.md` 的文件。
  3.  将 `gemini-md-vault` 仓库克隆到一个临时隐藏目录（例如 `/tmp/gmd-vault-clone`）。
  4.  将找到的 `GEMINI.md` 文件复制到临时克隆目录中，保留其在以项目命名的子目录中的相对路径（例如 `gmd-cli/rules/gemini/GEMINI.md`）。
  5.  在临时克隆目录中，执行 `git add .`、`git commit` 和 `git push`。
  6.  提交信息将自动生成，例如 `[gmd] Sync files for project 'my-project'`。
- **注意**：项目名称将从根目录的名称派生。

### 5.3. `gmd restore`

- **操作**：从数据保险库拉取最新的 `GEMINI.md` 文件，并将其放置到当前项目目录中。
- **工作流程**：
  1.  将 `gemini-md-vault` 仓库克隆到临时目录。
  2.  找到与当前项目对应的子目录。
  3.  将该子目录中的所有 `GEMINI.md` 文件复制回本地项目，重新创建正确的目录结构。
  4.  如果文件已存在，它将覆盖现有文件。

### 5.4. `gmd status`

- **操作**：比较本地 `GEMINI.md` 文件与数据保险库中的版本。
- **工作流程**：
  1.  执行保险库的临时克隆。
  2.  对于每个本地 `GEMINI.md` 文件，计算其哈希值。
  3.  将其哈希值与保险库中相应文件的哈希值进行比较。
  4.  显示状态：`new`（新增）、`modified`（已修改）、`untracked`（未跟踪）或 `synced`（已同步）。

### 5.5. `gmd list`

- **操作**：列出当前项目中数据保险库中跟踪的所有 `GEMINI.md` 文件。

### 5.6. `gmd log`

- **操作**：显示数据保险库中当前项目子目录的 Git 提交历史。
- **工作流程**：在保险库的临时克隆目录中，在项目子目录内执行 `git log`。

## 6. 开发计划

1.  **阶段 1: 基础**

    - 定义整体脚本结构和入口点（`gmd` 脚本）。
    - 实现子命令的基本参数解析（`init`、`sync` 等）。
    - 实现 `init` 命令：创建配置目录、`config.toml`，并提示输入 `vault_url`。

2.  **阶段 2: 核心逻辑**

    - 实现 `sync` 命令：查找项目根目录、扫描 `GEMINI.md` 文件、克隆保险库、复制文件，并执行 `git add`、`git commit`、`git push`。
    - 实现 `restore` 命令：克隆保险库，将文件复制回项目。

3.  **阶段 3: 只读命令**

    - 实现 `status`、`list` 和 `log`。

4.  **阶段 4: 优化与分发**
    - 添加健壮的错误处理和用户友好的输出。
    - 实现模块化（例如，将常见任务拆分为单独的函数）。
    - 考虑构建过程，将多个脚本合并为一个可执行文件以进行分发。
    - 编写 Bash 脚本的全面测试。
